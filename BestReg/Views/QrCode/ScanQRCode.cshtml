@{
    ViewData["Title"] = "Scan QR Code";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title text-center">Scan QR Code</h2>

                    <!-- Container for video stream -->
                    <div style="position: relative; width: 100%; padding-top: 56.25%; background: #000;">
                        <video id="video" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" autoplay></video>
                    </div>

                    <!-- Display scanned QR code data -->
                    <div id="qr-reader-results" class="mt-3 text-center"></div>

                    <!-- Hidden form to submit the scanned QR code data -->
                    <form id="checkInForm" asp-action="GetUserDetailsByQrCode" method="post">
                        <input type="hidden" id="qrCodeData" name="qrCodeData" />
                        <button type="submit" class="w-100 btn btn-lg btn-primary mt-3" id="checkInBtn" style="display:none;">
                            <span id="checkInText">Check In</span>
                            <span id="loader" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display:none;"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Include the jsQR library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script>
        const video = document.getElementById("video");
        const canvas = document.createElement('canvas');
        const context = canvas.getContext("2d");
        const qrResult = document.getElementById("qr-reader-results");
        const qrCodeDataInput = document.getElementById("qrCodeData");
        const checkInBtn = document.getElementById("checkInBtn");

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function (stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tick);
            })
            .catch(function (err) {
                console.error("Error accessing the camera: ", err);
                qrResult.innerHTML = `<span class="text-danger">Failed to access the camera.</span>`;
            });

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    qrResult.innerHTML = `<span class="text-success">QR Code detected: ${code.data}</span>`;
                    qrCodeDataInput.value = code.data;
                    checkInBtn.style.display = 'block'; // Show the Check In button
                }
            }
            requestAnimationFrame(tick);
        }
    </script>
}
